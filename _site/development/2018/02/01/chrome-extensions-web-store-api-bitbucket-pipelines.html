<!DOCTYPE html>
<html lang="en">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Simplify Chrome extension publishing with the Chrome Web Store Publish API &middot; lewisrodgers.com
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href=/assets/styles.css>
  <link rel="stylesheet" href=/assets/css/overrides.css>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:400,700%7CPT+Serif:400,400i,700">
  
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href=/assets/apple-touch-icon-precomposed.png>
  <link rel="shortcut icon" href=/assets/favicon.ico>

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="lewisrodgers.com" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">lewisrodgers.com</a>
          <small>Cloud enthusiast</small>
        </h3>
        <p class="heading-font">
          <a href="https://www.linkedin.com/in/lewisrodgers/" target="_blank">Linkedin</a> 
          | 
          <a href="https://twitter.com/lewisrodgers" target="_blank">Twitter</a>
        </p>
      </header>

      <main>
        <div class="byline">
  <div class="byline-avatar">
    <img class="avatar avatar-sm" src=http://localhost:4000/img/avatar.png alt="">
  </div>
  <div class="byline-meta">
    <div class="byline-author">Lewis Rodgers</div>
    <div class="byline-bio">Cloud architect and data engineer, IoT hobbyist, big fan of machine learning.</div>
    <div class="byline-post-date">
      <time datetime="2018-02-01T08:00:00-05:00">01 Feb 2018</time>
    </div>
  </div>
</div>

<article class="post">
  <h1 class="post-title">Simplify Chrome extension publishing with the Chrome Web Store Publish API</h1>
  <!-- <time datetime="2018-02-01T08:00:00-05:00" class="post-date">01 Feb 2018</time> -->
  <p>I was on a consulting engagement with a real estate development company in California. One of the projects involved building out a few Chrome extensions.</p>

<p>For this effort, the team included two developers and myself. I took on a DevOps role so that the others could focus on code. This meant I was responsible for versioning, packaging, uploading, and publishing the extensions to the Chrome Web Store (CWS, or just store). It allowed me to control what would be released for testing, QA, and to stakeholders.</p>

<p>The extensions were relatively small applications, and figured I could handle the DevOps manually. But that was a mistake. Turns out, juggling multiple extensions is really tricky.</p>

<p>In fact, at one point I packaged up the wrong extension files by mistake because I was in the wrong git branch.</p>

<p>But, with automated deployments you can avoid these mistakes. In this post, I’ll show you how to leverage the CWS Publish API and combine it with a continuous deployment tool like Travis CI or — in this case — Bitbucket Pipelines.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Make sure the following command line tools are installed on your machine:</p>

<ul>
  <li>curl - command-line tool for transferring data specified with URL syntax.</li>
  <li>zip - command-line tool for archiving files.</li>
  <li>jq - lightweight and flexible command-line JSON processor.</li>
</ul>

<h2 id="chrome-web-store-api">Chrome Web Store API</h2>

<p>What does the CWS Publish API do?</p>

<blockquote>
  <p>The Chrome Web Store Publish API provides a set of REST endpoints for programmatically creating, updating, and publishing items in the Chrome Web Store.</p>
</blockquote>

<p>It gives us a way to update an existing store item, and then publish that store item using code instead of visiting the Developer Dashboard. Here’s how the endpoints look:</p>

<p>Upload package for existing store item:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">"</span>  <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"x-goog-api-version: 2"</span> <span class="se">\</span>
<span class="nt">-X</span> PUT <span class="se">\</span>
<span class="nt">-T</span> <span class="nv">$FILE_NAME</span> <span class="se">\</span>
<span class="nt">-v</span> <span class="se">\</span>
https://www.googleapis.com/upload/chromewebstore/v1.1/items/<span class="nv">$APP_ID</span>
</code></pre></div></div>

<p>Publish a store item:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">"</span>  <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"x-goog-api-version: 2"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Length: 0"</span> <span class="se">\</span>
<span class="nt">-X</span> POST <span class="se">\</span>
<span class="nt">-v</span> <span class="se">\</span>
https://www.googleapis.com/chromewebstore/v1.1/items/<span class="nv">$APP_ID</span>/publish
</code></pre></div></div>

<p>These endpoints can be run using curl in the terminal, but we need a few things: an access token, our packaged extension, and the app ID of the extension we want to update or publish. Let’s address these in the next sections.</p>

<h2 id="access-token">Access Token</h2>

<p>First, take care of authorization. There’s a well documented guide in the official chrome developer docs on how to do this. So, head over to <a href="https://developer.chrome.com/webstore/using_webstore_api#beforeyoubegin">Using the Chrome Web Store Publish API</a> and do the steps under the section titled <a href="https://developer.chrome.com/webstore/using_webstore_api#beforeyoubegin">Before you begin</a>.</p>

<p>Come back after you have your access and refresh tokens.</p>

<h2 id="app-id">App ID</h2>

<p>The ID of your extension can be found either in the store or the <a href="https://chrome.google.com/webstore/developer/dashboard">Developer Dashboard</a>. Go to the dashboard. Find the extension you want to update, or publish. Then, open the <strong>More info</strong> panel to see its ID. Save for later.</p>

<p><img src="http://localhost:4000/img/app-id.png" alt="" /></p>

<h2 id="packaging-with-command-line">Packaging with command-line</h2>

<p>You probably already know that in order to upload an extension to the store, it should be packaged as a zip file. We don’t want to do this step manually, though. We want to automate it. The <strong>zip</strong> command will help with this.</p>

<p>For example, in the terminal we can do:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>zip <span class="nt">-r</span> my_file.zip <span class="nb">.</span>
</code></pre></div></div>

<p>And everything in the current directory will be compressed into a zip file.</p>

<p>We’ll adjust the command slightly in the next section.</p>

<h2 id="bitbucket-pipelines">Bitbucket Pipelines</h2>

<p>I’ve put together a basic Chrome extension starter project. <a href="https://bitbucket.org/lewis_rodgers/chrome-extension-continuous-delivery/get/89e088a5137e.zip">Download the code from Bitbucket</a>. Then, open <code class="highlighter-rouge">bitbucket-pipelines.yml</code>. This is the configuration file used by Bitbucket Pipelines.</p>

<p><em>For a detailed review of a Pipelines configuration file, see the <a href="https://confluence.atlassian.com/bitbucket/configure-bitbucket-pipelines-yml-792298910.html">official Bitbucket documentation</a>.</em></p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/dd39d48baf6cb041fd56a3ced01afcf1.js"> </script>

<p>The pipeline is divided into two parts by branch name: develop and master. The intent is to call the <strong>update</strong> endpoint when code is pushed to the develop branch. But, call the <strong>publish</strong> endpoint when code is pushed to the master branch.</p>

<p>Have a look at the block of code under the <strong>script</strong> keyword. I bet you’ll recognize the last three lines. Let’s look at them in more detail.</p>

<h2 id="package">Package</h2>

<p>The CWS Publish API requires extensions to be packaged as a zip file before upload. It’s a good idea to include only the required files needed for the extension to work. Exclude assets like unit tests, the node_modules folder, unrelated configuration files, etc.</p>

<p>Here’s a straightforward way to do this: Place extension–specific files into a subfolder called “app” and the zip command can be as simple as:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zip <span class="nt">-r</span> <span class="nv">$FILE_NAME</span> ./app
</code></pre></div></div>

<p><em>This line prevents us from ever packaging the wrong extension files!</em></p>

<h2 id="authorize">Authorize</h2>

<p>During the build process, Pipelines requests an access token so it can make calls to the CWS Publish API. The access token lasts for 40 minutes before it needs to be refreshed. This is where a refresh token comes into play.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ACCESS_TOKEN</span><span class="o">=</span><span class="k">$(</span>curl <span class="s2">"https://accounts.google.com/o/oauth2/token"</span> <span class="nt">-d</span> <span class="s2">"client_id=</span><span class="nv">$CLIENT_ID</span><span class="s2">&amp;client_secret=</span><span class="nv">$CLIENT_SECRET</span><span class="s2">&amp;refresh_token=</span><span class="nv">$REFRESH_TOKEN</span><span class="s2">&amp;grant_type=refresh_token&amp;redirect_uri=urn:ietf:wg:oauth:2.0:oob"</span> | jq <span class="nt">-r</span> <span class="s1">'.access_token'</span><span class="k">)</span>
</code></pre></div></div>

<h2 id="upload">Upload</h2>

<p>With the access token in hand, an authorized request to the API can be made to update the extension.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization:Bearer </span><span class="nv">$ACCESS_TOKEN</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"x-goog-api-version:2"</span> <span class="se">\</span>
<span class="nt">-X</span> PUT <span class="se">\</span>
<span class="nt">-T</span> <span class="nv">$FILE_NAME</span> <span class="se">\</span>
<span class="nt">-v</span> <span class="s2">"https://www.googleapis.com/upload/chromewebstore/v1.1/items/</span><span class="nv">$APP_ID</span><span class="s2">"</span>
</code></pre></div></div>

<h3 id="publish">Publish</h3>

<p>To publish the extension we can use the following request:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization:Bearer </span><span class="nv">$ACCESS_TOKEN</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"x-goog-api-version:2"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Length:0"</span> <span class="se">\</span>
<span class="nt">-X</span> POST <span class="se">\</span>
<span class="nt">-v</span> <span class="s2">"https://www.googleapis.com/chromewebstore/v1.1/items/</span><span class="nv">$APP_ID</span><span class="s2">/publish"</span>
</code></pre></div></div>

<h3 id="environment-variables">Environment variables</h3>

<p>To close the loop, we need to allow Bitbucket to continually interact with the CWS Publish API on our behalf. So, back in Bitbucket, add the client ID, client secret, refresh token, and app ID you’ve collected as environment variables to the <strong>Pipelines settings</strong> section.</p>

<p>The app ID is publicly available, but you’ll want to secure the others so they aren’t revealed to prying eyes.</p>

<p><img src="http://localhost:4000/img/environment-variables.png" alt="" /></p>

<p>From here, your team can start pushing code to the develop and master branches. Pipelines will take care of packaging the extension, uploading it to the store, and publishing it.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Updating and publishing extensions is a repetitive task and can be error prone when done manually. In this post, you learned about the Chrome Web Store Publish API and how it can be used to programmatically upload and publish extensions to the store. You also learned how to automate these tasks by combining the API with a continuous deployment tool.</p>

<p>If Bitbucket isn’t your thing, try adapting what you’ve learned to work with your specific development stack.</p>

</article>




      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2018-02-05T22:02:28-05:00">2018</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
     <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-64548447-1', 'auto');
       ga('send', 'pageview');
     </script>
    
  </body>
</html>
